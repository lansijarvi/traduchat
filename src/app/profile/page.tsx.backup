"use client";

import { useUser, useFirestore } from "@/firebase";
import { doc, getDoc, updateDoc, setDoc, serverTimestamp } from "firebase/firestore";
import { ref, uploadBytes, getDownloadURL } from "firebase/storage";
import { useStorage } from "@/firebase";
import { useEffect, useState, useRef } from "react";
import { useRouter } from "next/navigation";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import * as z from "zod";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
  FormDescription,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { useToast } from "@/hooks/use-toast";
import { Skeleton } from "@/components/ui/skeleton";
import { ArrowLeft, Upload, Camera } from "lucide-react";
import Link from "next/link";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";

const COUNTRIES = [
  { code: "US", name: "United States", flag: "ðŸ‡ºðŸ‡¸" },
  { code: "MX", name: "Mexico", flag: "ðŸ‡²ðŸ‡½" },
  { code: "ES", name: "Spain", flag: "ðŸ‡ªðŸ‡¸" },
  { code: "AR", name: "Argentina", flag: "ðŸ‡¦ðŸ‡·" },
  { code: "CO", name: "Colombia", flag: "ðŸ‡¨ðŸ‡´" },
  { code: "CL", name: "Chile", flag: "ðŸ‡¨ðŸ‡±" },
  { code: "PE", name: "Peru", flag: "ðŸ‡µðŸ‡ª" },
  { code: "VE", name: "Venezuela", flag: "ðŸ‡»ðŸ‡ª" },
  { code: "EC", name: "Ecuador", flag: "ðŸ‡ªðŸ‡¨" },
  { code: "GT", name: "Guatemala", flag: "ðŸ‡¬ðŸ‡¹" },
  { code: "CU", name: "Cuba", flag: "ðŸ‡¨ðŸ‡º" },
  { code: "BO", name: "Bolivia", flag: "ðŸ‡§ðŸ‡´" },
  { code: "DO", name: "Dominican Republic", flag: "ðŸ‡©ðŸ‡´" },
  { code: "HN", name: "Honduras", flag: "ðŸ‡­ðŸ‡³" },
  { code: "PY", name: "Paraguay", flag: "ðŸ‡µðŸ‡¾" },
  { code: "SV", name: "El Salvador", flag: "ðŸ‡¸ðŸ‡»" },
  { code: "NI", name: "Nicaragua", flag: "ðŸ‡³ðŸ‡®" },
  { code: "CR", name: "Costa Rica", flag: "ðŸ‡¨ðŸ‡·" },
  { code: "PA", name: "Panama", flag: "ðŸ‡µðŸ‡¦" },
  { code: "UY", name: "Uruguay", flag: "ðŸ‡ºðŸ‡¾" },
  { code: "GB", name: "United Kingdom", flag: "ðŸ‡¬ðŸ‡§" },
  { code: "CA", name: "Canada", flag: "ðŸ‡¨ðŸ‡¦" },
  { code: "FR", name: "France", flag: "ðŸ‡«ðŸ‡·" },
  { code: "DE", name: "Germany", flag: "ðŸ‡©ðŸ‡ª" },
  { code: "IT", name: "Italy", flag: "ðŸ‡®ðŸ‡¹" },
  { code: "PT", name: "Portugal", flag: "ðŸ‡µðŸ‡¹" },
  { code: "BR", name: "Brazil", flag: "ðŸ‡§ðŸ‡·" },
  { code: "JP", name: "Japan", flag: "ðŸ‡¯ðŸ‡µ" },
  { code: "CN", name: "China", flag: "ðŸ‡¨ðŸ‡³" },
  { code: "IN", name: "India", flag: "ðŸ‡®ðŸ‡³" },
  { code: "KR", name: "South Korea", flag: "ðŸ‡°ðŸ‡·" },
  { code: "AU", name: "Australia", flag: "ðŸ‡¦ðŸ‡º" },
  { code: "NZ", name: "New Zealand", flag: "ðŸ‡³ðŸ‡¿" },
];

const profileSchema = z.object({
  username: z.string().min(3, "Username must be at least 3 characters").regex(/^[a-z0-9_.]+$/, "Username can only contain lowercase letters, numbers, underscores, and periods."),
  language: z.enum(["en", "es"]),
  title: z.string().max(50, "Title must be 50 characters or less").optional(),
  bio: z.string().max(200, "Bio must be 200 characters or less").optional(),
  country: z.string().optional(),
  useGoogleAvatar: z.boolean(),
});

type ProfileFormValues = z.infer<typeof profileSchema>;

export default function ProfilePage() {
  const { user, loading: userLoading } = useUser();
  const db = useFirestore();
  const storage = useStorage();
  const router = useRouter();
  const { toast } = useToast();
  const [profileLoading, setProfileLoading] = useState(true);
  const [uploadingAvatar, setUploadingAvatar] = useState(false);
  const [customAvatarUrl, setCustomAvatarUrl] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const form = useForm<ProfileFormValues>({
    resolver: zodResolver(profileSchema),
    defaultValues: {
      username: "",
      language: "en",
      title: "",
      bio: "",
      country: "",
      useGoogleAvatar: true,
    },
  });

  const useGoogleAvatar = form.watch("useGoogleAvatar");

  useEffect(() => {
    if (userLoading) return;
    if (!user) {
      router.push("/login");
      return;
    }
    if (db && user) {
      const userRef = doc(db, "users", user.uid);
      getDoc(userRef).then((docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          form.reset({
            username: data.username || "",
            language: data.language || "en",
            title: data.title || "",
            bio: data.bio || "",
            country: data.country || "",
            useGoogleAvatar: data.useGoogleAvatar !== false,
          });
          setCustomAvatarUrl(data.customAvatarUrl || null);
        } else {
          const defaultUsername = user.email?.split('@')[0]?.toLowerCase().replace(/[^a-z0-9_.]/g, '') || 'user';
          form.reset({
            username: defaultUsername,
            language: "en",
            title: "",
            bio: "",
            country: "",
            useGoogleAvatar: true,
          });
        }
        setProfileLoading(false);
      });
    }
  }, [user, userLoading, db, router, form]);

  const handleAvatarUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file || !user || !storage) return;

    // Validate file
    if (!file.type.startsWith('image/')) {
      toast({
        variant: "destructive",
        title: "Invalid file",
        description: "Please upload an image file.",
      });
      return;
    }

    if (file.size > 5 * 1024 * 1024) {
      toast({
        variant: "destructive",
        title: "File too large",
        description: "Please upload an image smaller than 5MB.",
      });
      return;
    }

    setUploadingAvatar(true);
    try {
      const storageRef = ref(storage, `avatars/${user.uid}/${Date.now()}_${file.name}`);
      await uploadBytes(storageRef, file);
      const downloadURL = await getDownloadURL(storageRef);
      
      setCustomAvatarUrl(downloadURL);
      form.setValue("useGoogleAvatar", false);
      
      toast({
        title: "Avatar uploaded!",
        description: "Don't forget to save your changes.",
      });
    } catch (error: any) {
      console.error("Avatar upload error:", error);
      toast({
        variant: "destructive",
        title: "Upload failed",
        description: error.message,
      });
    } finally {
      setUploadingAvatar(false);
    }
  };

  async function onSubmit(values: ProfileFormValues) {
    if (!user || !db) return;
    try {
      const userRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(userRef);
      
      const avatarUrl = values.useGoogleAvatar ? user.photoURL : customAvatarUrl;
      
      const userData = {
        username: values.username.toLowerCase(),
        language: values.language,
        title: values.title || "",
        bio: values.bio || "",
        country: values.country || "",
        useGoogleAvatar: values.useGoogleAvatar,
        customAvatarUrl: customAvatarUrl || "",
        avatarUrl: avatarUrl || "",
      };
      
      if (docSnap.exists()) {
        await updateDoc(userRef, userData);
      } else {
        await setDoc(userRef, {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || values.username,
          ...userData,
          createdAt: serverTimestamp(),
        });
      }
      
      toast({
        title: "Profile Updated",
        description: "Your profile has been successfully updated.",
      });
    } catch (error: any) {
      console.error("Profile update error:", error);
      toast({
        variant: "destructive",
        title: "Error",
        description: error.message || "Could not update your profile.",
      });
    }
  }

  const currentAvatar = useGoogleAvatar ? user?.photoURL : customAvatarUrl;
  const countryData = COUNTRIES.find(c => c.code === form.watch("country"));
  
  if (userLoading || profileLoading) {
    return (
        <div className="flex min-h-screen items-center justify-center bg-background p-4">
            <Card className="w-full max-w-2xl">
                <CardHeader>
                    <Skeleton className="h-8 w-48" />
                    <Skeleton className="h-4 w-64" />
                </CardHeader>
                <CardContent className="space-y-6">
                    <div className="space-y-2">
                        <Skeleton className="h-4 w-24" />
                        <Skeleton className="h-10 w-full" />
                    </div>
                     <Skeleton className="h-10 w-full" />
                </CardContent>
            </Card>
        </div>
    );
  }

  return (
    <div className="flex min-h-screen items-start justify-center bg-background p-4 pt-16 sm:pt-24">
       <div className="absolute left-4 top-4">
            <Button asChild variant="ghost" size="icon">
                <Link href="/">
                    <ArrowLeft />
                </Link>
            </Button>
       </div>
      <Card className="w-full max-w-2xl">
        <CardHeader>
          <CardTitle>Your Profile</CardTitle>
          <CardDescription>Customize your profile with avatar, bio, and more.</CardDescription>
        </CardHeader>
        <CardContent>
          <Form {...form}>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
              
              {/* Avatar Section */}
              <div className="flex flex-col items-center gap-4 pb-6 border-b">
                <Avatar className="h-24 w-24">
                  <AvatarImage src={currentAvatar || ""} />
                  <AvatarFallback className="bg-cyan text-background text-2xl">
                    {form.watch("username")?.[0]?.toUpperCase() || "U"}
                  </AvatarFallback>
                </Avatar>
                
                <FormField
                  control={form.control}
                  name="useGoogleAvatar"
                  render={({ field }) => (
                    <FormItem className="flex flex-col items-center gap-2">
                      <div className="flex gap-2">
                        <Button
                          type="button"
                          variant={field.value ? "default" : "outline"}
                          size="sm"
                          onClick={() => field.onChange(true)}
                          className={field.value ? "bg-cyan hover:bg-cyan/90" : ""}
                        >
                          Use Google Avatar
                        </Button>
                        <Button
                          type="button"
                          variant={!field.value ? "default" : "outline"}
                          size="sm"
                          onClick={() => {
                            field.onChange(false);
                            if (!customAvatarUrl) {
                              fileInputRef.current?.click();
                            }
                          }}
                          className={!field.value ? "bg-orange hover:bg-orange/90" : ""}
                        >
                          <Upload className="h-4 w-4 mr-2" />
                          Upload Custom
                        </Button>
                      </div>
                      <input
                        ref={fileInputRef}
                        type="file"
                        accept="image/*"
                        onChange={handleAvatarUpload}
                        className="hidden"
                      />
                      {uploadingAvatar && <p className="text-sm text-muted-foreground">Uploading...</p>}
                      {!field.value && customAvatarUrl && (
                        <Button
                          type="button"
                          variant="ghost"
                          size="sm"
                          onClick={() => fileInputRef.current?.click()}
                        >
                          <Camera className="h-4 w-4 mr-2" />
                          Change Photo
                        </Button>
                      )}
                    </FormItem>
                  )}
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <FormField
                  control={form.control}
                  name="username"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Username</FormLabel>
                      <FormControl>
                        <Input placeholder="your_username" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="language"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Preferred Language</FormLabel>
                      <Select onValueChange={field.onChange} value={field.value}>
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Select language" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          <SelectItem value="en">ðŸ‡ºðŸ‡¸ English</SelectItem>
                          <SelectItem value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</SelectItem>
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <FormField
                  control={form.control}
                  name="title"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Title</FormLabel>
                      <FormControl>
                        <Input placeholder="e.g. Software Engineer" {...field} />
                      </FormControl>
                      <FormDescription>Your role or occupation</FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="country"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Country</FormLabel>
                      <Select onValueChange={field.onChange} value={field.value}>
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Select country" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent className="max-h-[300px]">
                          {COUNTRIES.map((country) => (
                            <SelectItem key={country.code} value={country.code}>
                              {country.flag} {country.name}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>

              <FormField
                control={form.control}
                name="bio"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Bio</FormLabel>
                    <FormControl>
                      <Textarea 
                        placeholder="Tell others about yourself..." 
                        className="resize-none"
                        rows={3}
                        {...field} 
                      />
                    </FormControl>
                    <FormDescription>
                      {field.value?.length || 0}/200 characters
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <Button type="submit" className="w-full bg-cyan hover:bg-cyan/90 touch-manipulation active:scale-95 transition-transform">
                Save Changes
              </Button>
            </form>
          </Form>
        </CardContent>
      </Card>
    </div>
  );
}
